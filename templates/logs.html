{% extends "base.html" %}
{% block title %}Moje záznamy{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Moje záznamy</h2>

  <!-- Tlačítka pro export -->
  <div class="mb-3">
    <a href="{{ url_for('export_csv') }}" class="btn btn-success me-2">Export do CSV</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-primary">Export do Excelu</a>
  </div>

  <!-- Vyhledávací pole pro filtrování záznamů -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Vyhledat záznam...">
    </div>
  </div>

  <table class="table table-striped" id="logsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Projekt</th>
        <th>Začátek</th>
        <th>Konec</th>
        <th>Start pauzy</th>
        <th>Konec pauzy</th>
        <th>Poznámka</th>
        <th>Odpracované hodiny</th>
        <th>Akce</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr class="{% if not log.end_time %}table-warning{% endif %}">
        <td>{{ log.id }}</td>
        <td>{{ log.project_name }}</td>
        <td>
          {% if log.start_time %}
            {{ log.start_time.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if log.end_time %}
            {{ log.end_time.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if log.pause_start %}
            {{ log.pause_start.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if log.pause_end %}
            {{ log.pause_end.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if log.note %}
            {% if log.note|length > 30 %}
              {{ log.note[:30] }}...
              <a href="#" data-bs-toggle="modal" data-bs-target="#noteModal{{ log.id }}">Více</a>

              <!-- Modal pro zobrazení celé poznámky -->
              <div class="modal fade" id="noteModal{{ log.id }}" tabindex="-1" aria-labelledby="noteModalLabel{{ log.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="noteModalLabel{{ log.id }}">Celá poznámka</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                    </div>
                    <div class="modal-body">
                      {{ log.note }}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              {{ log.note }}
            {% endif %}
          {% else %}
            -
          {% endif %}
        </td>
        <td>{{ log.hours|round(2) }}</td>
        <td>
          <a href="{{ url_for('edit_log', log_id=log.id) }}" class="btn btn-warning btn-sm">Upravit</a>
          <form method="post" action="{{ url_for('delete_log', log_id=log.id) }}" style="display:inline;">
            <button type="submit" class="btn btn-danger btn-sm">Smazat</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Načtení Bootstrap JS (nutné pro modaly) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Skript pro filtrování řádků -->
<script>
  document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#logsTable tbody tr');
    rows.forEach(function(row) {
      row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
  });
</script>
{% endblock %}
